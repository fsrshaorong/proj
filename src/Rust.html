<!--杨子霄负责-->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rust编译器前端</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        :root {
            --primary: #3a86ff;
            --secondary: #ff006e;
            --dark: #1a1a2e;
            --light: #f8f9fa;
            --success: #06d6a0;
            --warning: #ffd166;
            --danger: #ef476f;
            --gray: #6c757d;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: var(--light);
            min-height: 100vh;
            padding: 20px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 30px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo h1 {
            font-size: 2.5rem;
            background: linear-gradient(90deg, var(--primary), var(--success));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 800;
        }

        .logo i {
            font-size: 2.8rem;
            color: var(--primary);
        }

        .controls {
            display: flex;
            gap: 15px;
        }

        .btn {
            padding: 12px 25px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: #2a75f0;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(58, 134, 255, 0.4);
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }

        .btn-outline:hover {
            background: rgba(58, 134, 255, 0.1);
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 30px;
        }

        .panel {
            background: rgba(30, 30, 46, 0.7);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            display: flex;
            flex-direction: column;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .panel-title {
            font-size: 1.4rem;
            font-weight: 600;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .panel-actions {
            display: flex;
            gap: 10px;
        }

        .editor-container {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        #editor {
            flex: 1;
            background: rgba(10, 10, 20, 0.7);
            border-radius: 8px;
            padding: 15px;
            font-family: 'Fira Code', monospace;
            font-size: 16px;
            color: #e2e2e2;
            border: 1px solid rgba(255, 255, 255, 0.05);
            line-height: 1.6;
            resize: none;
            overflow: auto;
        }

        #editor:focus {
            outline: none;
            border-color: var(--primary);
        }

        .visualization-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 25px;
        }

        .tokens-container {
            max-height: 600px;
            overflow-y: auto;
        }

        .token-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
        }

        .token-card {
            background: rgba(10, 10, 20, 0.7);
            border-radius: 8px;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
        }

        .token-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
            box-shadow: 0 5px 15px rgba(58, 134, 255, 0.2);
        }

        .token-type {
            font-size: 0.85rem;
            color: var(--primary);
            font-weight: 600;
            margin-bottom: 5px;
        }

        .token-value {
            font-family: 'Fira Code', monospace;
            font-size: 0.95rem;
            color: var(--light);
            word-break: break-all;
        }

        .tree-container {
            height: 600px;
            background: rgba(10, 10, 20, 0.7);
            border-radius: 8px;
            overflow: auto;
            border: 1px solid rgba(255, 255, 255, 0.05);
            position: relative;
        }

        #tree-visualization {
            width: 100%;
            height: 100%;
        }

        .zoom-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 10;
            display: flex;
            gap: 5px;
        }

        .zoom-btn {
            width: 30px;
            height: 30px;
            background: rgba(30, 30, 46, 0.8);
            border: 1px solid var(--primary);
            color: white;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .char-tree-container {
            height: 300px;
            background: rgba(10, 10, 20, 0.7);
            border-radius: 8px;
            overflow: auto;
            padding: 15px;
            font-family: 'Fira Code', monospace;
            font-size: 14px;
            line-height: 1.4;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .char-tree {
            white-space: pre;
            font-family: 'Fira Code', monospace;
            color: #e2e2e2;
            line-height: 1.8;
        }

        .char-tree .node-root {
            color: #3a86ff;
            font-weight: bold;
        }

        .char-tree .node-internal {
            color: #ff6b6b;
        }

        .char-tree .node-leaf {
            color: #06d6a0;
        }

        .errors-container {
            margin-top: 30px;
        }

        .error-list {
            background: rgba(239, 71, 111, 0.1);
            border-radius: 8px;
            padding: 20px;
            border: 1px solid rgba(239, 71, 111, 0.3);
            max-height: 200px;
            overflow-y: auto;
        }

        .error-item {
            padding: 12px 15px;
            background: rgba(239, 71, 111, 0.15);
            border-radius: 6px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-family: 'Fira Code', monospace;
        }

        .error-icon {
            color: var(--danger);
            font-size: 1.2rem;
        }

        .error-location {
            color: var(--warning);
            font-weight: 600;
            margin-left: 5px;
        }

        .export-panel {
            margin-top: 30px;
        }

        .export-options {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        #exportPreview {
            margin-top: 20px;
            height: 300px;
            overflow: auto;
            background-color: rgba(10, 10, 20, 0.7);
            padding: 15px;
            border-radius: 8px;
            font-family: 'Fira Code', monospace;
            white-space: pre-wrap;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .footer {
            text-align: center;
            padding: 30px 0;
            color: var(--gray);
            font-size: 0.9rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            margin-top: 20px;
        }

        .legend {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .legend-color {
            width: 15px;
            height: 15px;
            border-radius: 3px;
        }

        .keyword { background-color: #ff6b6b; }
        .identifier { background-color: #4ecdc4; }
        .literal { background-color: #ffe66d; }
        .operator { background-color: #6a0572; }
        .punctuation { background-color: #ff9a8b; }

        .parse-tree-container {
            background: rgba(10, 10, 20, 0.7);
            border-radius: 8px;
            padding: 15px;
            max-height: 400px;
            overflow: auto;
            font-family: 'Fira Code', monospace;
            font-size: 14px;
            line-height: 1.4;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .parse-tree-node {
            color: #3a86ff;
            font-weight: bold;
        }

        .parse-tree-leaf {
            color: #06d6a0;
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .visualization-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <header>
        <div class="logo">
            <i class="fas fa-code"></i>
            <h1>Rust编译器前端</h1>
        </div>
        <div class="controls">
            <button class="btn btn-primary" id="compile-btn">
                <i class="fas fa-play"></i> 编译
            </button>
            <button class="btn btn-outline" id="reset-btn">
                <i class="fas fa-redo"></i> 重置
            </button>
        </div>
    </header>

    <div class="main-content">
        <div class="panel editor-container">
            <div class="panel-header">
                <h2 class="panel-title">
                    <i class="fas fa-code"></i> Rust代码编辑器
                </h2>
                <div class="panel-actions">
                    <button class="btn btn-outline" id="example-btn">
                        <i class="fas fa-file-code"></i> 加载示例
                    </button>
                </div>
            </div>
            <textarea id="editor">fn main() {
    println!("Hello, Rust!");
}</textarea>
        </div>

        <div class="panel">
            <div class="panel-header">
                <h2 class="panel-title">
                    <i class="fas fa-project-diagram"></i> 编译器可视化
                </h2>
            </div>

            <div class="visualization-container">
                <div class="tokens-panel">
                    <h3 class="panel-title">
                        <i class="fas fa-list"></i> TokenStream
                    </h3>
                    <div class="tokens-container">
                        <div class="token-grid" id="tokens-container"></div>
                    </div>
                </div>

                <div class="tree-panel">
                    <h3 class="panel-title">
                        <i class="fas fa-tree"></i> AST
                    </h3>
                    <div class="tree-container">
                        <div class="zoom-controls">
                            <button class="zoom-btn" id="zoom-in">+</button>
                            <button class="zoom-btn" id="zoom-out">-</button>
                            <button class="zoom-btn" id="reset-view">↺</button>
                        </div>
                        <svg id="tree-visualization"></svg>
                    </div>
                </div>
            </div>

            <div class="visualization-container">
                <div class="char-tree-panel" style="grid-column: span 2;">
                    <h3 class="panel-title">
                        <i class="fas fa-code"></i> ParseTree
                    </h3>
                    <div class="char-tree-container">
                        <pre id="char-tree" class="char-tree"></pre>
                    </div>
                </div>
            </div>

            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color keyword"></div>
                    <span>关键字</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color identifier"></div>
                    <span>标识符</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color literal"></div>
                    <span>字面量</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color operator"></div>
                    <span>操作符</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color punctuation"></div>
                    <span>标点符号</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #3a86ff;"></div>
                    <span>根节点</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #ff6b6b;"></div>
                    <span>内部节点</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #06d6a0;"></div>
                    <span>叶子节点</span>
                </div>
            </div>

            <div class="errors-container">
                <h3 class="panel-title">
                    <i class="fas fa-exclamation-triangle"></i> 编译错误
                </h3>
                <div class="error-list" id="error-list">
                    <div class="error-item">
                        <i class="fas fa-check-circle error-icon" style="color: #06d6a0"></i>
                        <span>未检测到错误</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="panel export-panel">
            <div class="panel-header">
                <h2 class="panel-title">
                    <i class="fas fa-download"></i> 导出结果
                </h2>
            </div>
            <div>
                <div style="margin-bottom: 20px;">
                    <h3>导出编译结果</h3>
                    <p>选择导出格式并下载结果文件：</p>
                </div>
                <div class="export-options">
                    <button class="btn btn-outline" id="exportDot">
                        <i class="fas fa-project-diagram"></i> DOT格式
                    </button>
                    <button class="btn btn-outline" id="exportJson">
                        <i class="fas fa-file-code"></i> JSON格式
                    </button>
                    <button class="btn btn-outline" id="exportXml">
                        <i class="fas fa-file-alt"></i> XML格式
                    </button>
                </div>
                <div id="exportPreview"></div>
            </div>
        </div>
    </div>

    <div class="footer">
        <p>基于ANTLR的Rust编译器前端 | 为Rust开发者打造</p>
        <p>ANTLR v4.13.1 | Rust 2021 Edition</p>
    </div>
</div>

<script>
    // DOM元素
    const editor = document.getElementById('editor');
    const compileBtn = document.getElementById('compile-btn');
    const resetBtn = document.getElementById('reset-btn');
    const exampleBtn = document.getElementById('example-btn');
    const tokensContainer = document.getElementById('tokens-container');
    const errorList = document.getElementById('error-list');
    const exportDot = document.getElementById('exportDot');
    const exportJson = document.getElementById('exportJson');
    const exportXml = document.getElementById('exportXml');
    const exportPreview = document.getElementById('exportPreview');
    const charTree = document.getElementById('char-tree');
    const zoomInBtn = document.getElementById('zoom-in');
    const zoomOutBtn = document.getElementById('zoom-out');
    const resetViewBtn = document.getElementById('reset-view');

    // 当前数据状态
    let currentData = {
        tokens: [],
        parseTree: null,
        ast: null,
        charTree: null
    };

    // 编译代码
    async function compileCode() {
        const code = editor.value;

        // 显示加载状态
        compileBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 编译中...';
        compileBtn.disabled = true;

        try {
            const response = await fetch('http://localhost:4567/compile', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ code })
            });

            const data = await response.json();

            if (!response.ok) {
                // 处理ANTLR解析错误
                if (data.errors) {
                    const errors = data.errors.map(err => {
                        // 解析错误信息，格式为"行 x:y - 消息"
                        const match = err.match(/行 (\d+):(\d+) - (.*)/);
                        if (match) {
                            return {
                                message: match[3],
                                line: parseInt(match[1]),
                                column: parseInt(match[2])
                            };
                        } else {
                            return {
                                message: err,
                                line: 1,
                                column: 1
                            };
                        }
                    });
                    showErrors(errors);
                } else {
                    throw new Error(data.error || `服务器错误: ${response.status}`);
                }
                return;
            }

            // 更新当前数据
            currentData.tokens = data.tokens;
            currentData.parseTree = data.parseTree;
            currentData.ast = data.ast;
            currentData.charTree = data.charTree;

            // 渲染结果
            renderTokens(currentData.tokens);
            renderAST(currentData.ast);
            renderCharTree(currentData.charTree);
            showErrors([]);

        } catch (error) {
            showErrors([{
                message: error.message || "未知错误",
                line: 1,
                column: 1
            }]);
        } finally {
            // 重置按钮状态
            compileBtn.innerHTML = '<i class="fas fa-play"></i> 编译';
            compileBtn.disabled = false;
        }
    }

    // 在UI中渲染Token
    function renderTokens(tokens) {
        tokensContainer.innerHTML = '';

        tokens.forEach(token => {
            const tokenCard = document.createElement('div');
            tokenCard.className = 'token-card';

            // 确定Token类型用于样式
            let typeClass = '';
            if (token.type.includes('KEYWORD')) typeClass = 'keyword';
            else if (token.type.includes('IDENTIFIER')) typeClass = 'identifier';
            else if (token.type.includes('LITERAL')) typeClass = 'literal';
            else if (token.type.includes('OPERATOR')) typeClass = 'operator';
            else if (token.type.includes('PUNCTUATION')) typeClass = 'punctuation';

            tokenCard.innerHTML = `
                    <div class="token-type ${typeClass}">${token.type}</div>
                    <div class="token-value">${token.value}</div>
                    <div class="token-location">第${token.line}行, 第${token.col}列</div>
                `;

            tokensContainer.appendChild(tokenCard);
        });
    }

    // 使用D3.js渲染AST
    function renderAST(data) {
        const svg = d3.select("#tree-visualization");
        svg.html("");

        const container = document.querySelector('.tree-container');
        const width = container.clientWidth;
        const height = container.clientHeight;
        const margin = { top: 50, right: 150, bottom: 50, left: 150 };

        // 创建缩放行为
        const zoom = d3.zoom()
            .scaleExtent([0.1, 5])
            .on("zoom", (event) => {
                g.attr("transform", event.transform);
            });

        svg.call(zoom);

        // 创建SVG容器
        const g = svg
            .attr("width", width)
            .attr("height", height)
            .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        // 创建树布局
        const treeLayout = d3.tree()
            .size([height - margin.top - margin.bottom, width - margin.left - margin.right])
            .nodeSize([80, 250]); // 增加节点间距

        // 转换数据
        const root = d3.hierarchy(data);

        // 计算节点位置
        treeLayout(root);

        // 创建连接线
        const link = g.selectAll(".link")
            .data(root.links())
            .enter().append("path")
            .attr("class", "link")
            .attr("d", d3.linkHorizontal()
                .x(d => d.y)
                .y(d => d.x))
            .attr("fill", "none")
            .attr("stroke", "#555")
            .attr("stroke-width", 1.5);

        // 创建节点组
        const node = g.selectAll(".node")
            .data(root.descendants())
            .enter().append("g")
            .attr("class", "node")
            .attr("transform", d => `translate(${d.y},${d.x})`);

        // 添加节点圆圈
        node.append("circle")
            .attr("r", 10)
            .attr("fill", d => d.children ? "#ff6b6b" : "#06d6a0");

        // 添加节点文本
        node.append("text")
            .attr("dy", "0.31em")
            .attr("x", d => d.children ? -15 : 15)
            .attr("text-anchor", d => d.children ? "end" : "start")
            .text(d => d.data.type)
            .attr("fill", "white")
            .attr("font-size", "12px");

        // 添加值文本
        node.filter(d => d.data.value)
            .append("text")
            .attr("dy", "1.5em")
            .attr("x", d => d.children ? -15 : 15)
            .attr("text-anchor", d => d.children ? "end" : "start")
            .text(d => d.data.value)
            .attr("fill", "#aaa")
            .attr("font-size", "10px");

        // 添加缩放事件监听
        zoomInBtn.addEventListener('click', () => {
            svg.transition().call(zoom.scaleBy, 1.2);
        });

        zoomOutBtn.addEventListener('click', () => {
            svg.transition().call(zoom.scaleBy, 0.8);
        });

        resetViewBtn.addEventListener('click', () => {
            svg.transition().call(zoom.transform, d3.zoomIdentity);
        });
    }

    // 渲染字符绘制的ParseTree
    function renderCharTree(treeString) {
        charTree.textContent = treeString;

        // 添加样式
        const lines = treeString.split('\n');
        let html = '';

        lines.forEach(line => {
            if (line.includes('└─') || line.includes('├─')) {
                const nodeText = line.substring(line.lastIndexOf('─') + 2);
                if (nodeText === 'compilationUnit') {
                    html += `<span class="node-root">${line}</span>\n`;
                } else if (line.includes('(') || nodeText.startsWith('rule')) {
                    html += `<span class="node-internal">${line}</span>\n`;
                } else {
                    html += `<span class="node-leaf">${line}</span>\n`;
                }
            } else {
                html += line + '\n';
            }
        });

        charTree.innerHTML = html;
    }

    // 在UI中显示错误
    function showErrors(errors) {
        errorList.innerHTML = '';

        if (errors.length === 0) {
            errorList.innerHTML = `
                    <div class="error-item">
                        <i class="fas fa-check-circle error-icon" style="color: #06d6a0"></i>
                        <span>未检测到错误</span>
                    </div>
                `;
            return;
        }

        errors.forEach(error => {
            const errorItem = document.createElement('div');
            errorItem.className = 'error-item';
            errorItem.innerHTML = `
                    <i class="fas fa-times-circle error-icon"></i>
                    <span>${error.message} <span class="error-location">(第${error.line}行:第${error.column}列)</span></span>
                `;
            errorList.appendChild(errorItem);
        });
    }

    // 加载示例代码
    function loadExample() {
        editor.value = `fn main() {
    // 计算斐波那契数列
    let n = 10;
    let mut a = 0;
    let mut b = 1;

    for _ in 0..n {
        let temp = a;
        a = b;
        b = temp + b;
    }

    println!("斐波那契数列第{}项: {}", n, a);
}`;
    }

    // 生成DOT格式
    function generateDotFormat(ast) {
        let dot = 'digraph AST {\n';
        dot += '  node [shape=box, style="rounded,filled", fillcolor=lightgray];\n\n';

        let counter = 0;
        const nodeMap = new Map();

        function traverse(node) {
            const id = `node${counter++}`;
            nodeMap.set(node, id);

            let label = node.type;
            if (node.value) {
                label += `\\n${node.value}`;
            }

            dot += `  ${id} [label="${label}"];\n`;

            if (node.children) {
                node.children.forEach(child => {
                    const childId = traverse(child);
                    dot += `  ${id} -> ${childId};\n`;
                });
            }

            return id;
        }

        traverse(ast);
        dot += '}';

        return dot;
    }

    // 生成XML格式
    function generateXmlFormat(ast) {
        let xml = '<?xml version="1.0" encoding="UTF-8"?>\n';
        xml += '<ast>\n';

        function traverse(node, depth) {
            const indent = '  '.repeat(depth);
            xml += `${indent}<node type="${node.type}"${node.value ? ` value="${node.value}"` : ''}>\n`;

            if (node.children) {
                node.children.forEach(child => {
                    traverse(child, depth + 1);
                });
            }

            xml += `${indent}</node>\n`;
        }

        traverse(ast, 1);
        xml += '</ast>';

        return xml;
    }

    // 事件监听器
    compileBtn.addEventListener('click', compileCode);
    resetBtn.addEventListener('click', () => {
        editor.value = '';
        tokensContainer.innerHTML = '';
        errorList.innerHTML = '<div class="error-item"><i class="fas fa-check-circle error-icon" style="color: #06d6a0"></i><span>未检测到错误</span></div>';
        d3.select("#tree-visualization").html("");
        charTree.textContent = '';
    });
    exampleBtn.addEventListener('click', loadExample);

    // 导出事件监听
    exportDot.addEventListener('click', () => {
        if (!currentData.ast) {
            alert('错误：没有可导出的数据');
            return;
        }
        exportPreview.textContent = generateDotFormat(currentData.ast);
    });

    exportJson.addEventListener('click', () => {
        if (!currentData.ast) {
            alert('错误：没有可导出的数据');
            return;
        }
        exportPreview.textContent = JSON.stringify(currentData, null, 2);
    });

    exportXml.addEventListener('click', () => {
        if (!currentData.ast) {
            alert('错误：没有可导出的数据');
            return;
        }
        exportPreview.textContent = generateXmlFormat(currentData.ast);
    });
</script>
</body>
</html>